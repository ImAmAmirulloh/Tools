<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materi App - Ultimate Block Editor</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #e0e5ec;
            --paper-width: 210mm;
            --gutter-width: 150px;
            --sidebar-width: 260px;
            --accent-color: #2c3e50;
            /* VARIABEL KUNCI UNTUK KESEJAJARAN */
            --indent-size: 40px; 
        }

        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; background-color: var(--bg-color); }
        * { box-sizing: border-box; }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width); background-color: #2c3e50; color: #ecf0f1;
            display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 20;
        }
        #sidebar .brand { font-size: 1.2rem; text-align: center; padding: 20px 0; font-weight: bold; background: #1a252f; }
        .sidebar-content { padding: 20px; flex-grow: 1; }
        .sidebar-footer { padding: 20px; background: #233342; border-top: 1px solid #34495e; }

        /* --- MAIN AREA --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }

        .toolbar {
            background: white; padding: 10px 20px; height: 65px; border-bottom: 1px solid #ccc;
            display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 10;
        }

        .paper-container { flex-grow: 1; overflow-y: auto; padding: 40px; display: flex; justify-content: center; }

        /* EDITOR LAYOUT */
        .editor-wrapper {
            display: flex; flex-direction: row;
            width: calc(var(--paper-width) + var(--gutter-width) + 20px);
        }

        .paper {
            width: var(--paper-width); min-height: 297mm; background: white;
            padding: 25mm 25mm; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            color: #333; font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.5;
        }

        /* --- BLOCK SYSTEM --- */
        .block-row { display: flex; width: 100%; margin-bottom: 12px; position: relative; }

        /* BADGE DI GUTTER (KIRI) */
        .type-badge-container {
            position: absolute; left: calc(-1 * var(--gutter-width) - 15px);
            width: var(--gutter-width); text-align: right; top: 0;
        }
        .type-badge {
            display: inline-block; background: white; border: 2px solid #333; border-radius: 4px;
            padding: 4px 10px; font-family: sans-serif; font-size: 11px; font-weight: bold;
            color: #333; cursor: pointer; box-shadow: 3px 3px 0px rgba(0,0,0,0.15);
            transition: 0.1s; user-select: none; white-space: nowrap;
        }
        .type-badge:hover { background: #f0f0f0; transform: translate(-1px, -1px); }
        .type-badge:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0px rgba(0,0,0,0.15); }

        /* KONTEN (KANAN) */
        .block-content { flex-grow: 1; display: flex; flex-direction: column; }
        
        .flex-row { display: flex; align-items: flex-start; }

        /* MARKER DI DALAM KERTAS */
        .inner-marker { 
            min-width: var(--indent-size); /* Lebar tetap agar teks setelahnya sejajar vertikal */
            font-weight: bold; flex-shrink: 0; display: inline-block;
        }

        .content-editable { outline: none; flex-grow: 1; word-wrap: break-word; min-height: 1.2em; }
        .content-paragraph { text-align: justify; }
        
        /* LOGIKA MARGIN ANAK (SUB-POINT) */
        .node-children { 
            margin-top: 5px; 
            margin-left: var(--indent-size); /* SEJAJAR DENGAN HURUF PERTAMA INDUK */
            border-left: 1px dashed #eee; padding-left: 5px; 
        }
        /* Jika di dalam anak ada paragraf, hilangkan indentasi tambahan */
        .node-children .content-paragraph { text-indent: 0 !important; }

        /* CONTROLS HOVER */
        .hover-controls {
            opacity: 0; position: absolute; right: -35px; top: 0;
            display: flex; flex-direction: column; gap: 3px; transition: 0.2s;
        }
        .block-row:hover .hover-controls { opacity: 1; }
        .btn-mini { width: 24px; height: 24px; border: 1px solid #ccc; background: white; cursor: pointer; border-radius: 3px; font-size: 10px; }
        .btn-mini:hover { background: #eee; }

        /* MODALS & DROPDOWNS */
        .type-selector {
            position: fixed; background: white; border: 2px solid #333; border-radius: 6px;
            box-shadow: 5px 5px 20px rgba(0,0,0,0.2); z-index: 1000; display: none;
            width: 200px; padding: 5px;
        }
        .type-option { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; }
        .type-option:hover { background: #f0f0f0; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-box { background: white; padding: 25px; border-radius: 8px; width: 500px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); }

        /* BUTTONS */
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-primary { background: #3498db; color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #333; }
        .btn-full { width: 100%; margin-bottom: 10px; }

        @media print {
            #sidebar, .toolbar, .type-badge-container, .hover-controls, .type-selector { display: none !important; }
            .paper-container { padding: 0; overflow: visible; background: white; }
            .paper { box-shadow: none; width: 100%; margin: 0; padding: 0; }
            .node-children { border-left: none; }
            body { background: white; }
        }
    </style>
</head>
<body>

    <nav id="sidebar">
        <div class="brand">MATERI BUILDER</div>
        <div class="sidebar-content">
            <button class="btn btn-outline btn-full" onclick="openPasteModal()"><i class="fas fa-paste"></i> Smart Paste Text</button>
            <hr style="border: 0; border-top: 1px solid #444; margin: 20px 0;">
            <div style="font-size: 11px; color: #888; margin-bottom: 10px; letter-spacing: 1px;">IMPORT / EXPORT</div>
            <input type="file" id="fileInput" style="display:none" onchange="handleFileImport(this)">
            <button class="btn btn-outline btn-full" onclick="document.getElementById('fileInput').click()"><i class="fas fa-file-import"></i> Import DOCX / JSON</button>
            <button class="btn btn-primary btn-full" onclick="saveJson()"><i class="fas fa-save"></i> Save JSON</button>
        </div>
        <div class="sidebar-footer">
            <button class="btn btn-outline btn-full" onclick="createNew()"><i class="fas fa-file"></i> Buat Baru</button>
        </div>
    </nav>

    <div class="main-content">
        <div class="toolbar">
            <input type="text" id="docFilename" value="Materi_Ekonomi_Publik" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 250px;">
            
            <div style="display:flex; align-items:center; gap:10px; border-left:1px solid #ddd; padding-left:15px; margin-left:10px; font-size:12px;">
                <i class="fas fa-arrows-alt-h"></i> Indentasi: 
                <input type="range" min="20" max="100" value="40" oninput="updateMargin(this.value)" style="cursor:pointer; width: 120px;">
                <span id="marginVal">40px</span>
            </div>

            <div style="flex-grow:1"></div>
            <button class="btn btn-outline" onclick="addRootNode()"><i class="fas fa-plus"></i> Tambah Bab</button>
            <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> PDF / Print</button>
        </div>

        <div class="paper-container">
            <div class="editor-wrapper">
                <div class="paper" id="paper">
                    </div>
            </div>
        </div>
    </div>

    <div id="typeSelector" class="type-selector">
        <div style="padding: 5px 10px; font-size: 10px; color: #999; font-weight: bold;">PILIH TIPE BLOK</div>
        <div class="type-option" onclick="setBlockType('paragraph')"><i class="fas fa-align-left"></i> Paragraf</div>
        <div class="type-option" onclick="setBlockType('custom')"><i class="fas fa-pen"></i> Custom Point</div>
        <hr style="margin: 2px 0; border: 0; border-top: 1px solid #eee;">
        <div class="type-option" onclick="setBlockType('A.')"><b>A.</b> Huruf Besar (A.)</div>
        <div class="type-option" onclick="setBlockType('a.')"><b>a.</b> Huruf Kecil (a.)</div>
        <div class="type-option" onclick="setBlockType('a)')"><b>a)</b> Huruf Kurung (a)</div>
        <div class="type-option" onclick="setBlockType('1.')"><b>1.</b> Angka (1.)</div>
        <div class="type-option" onclick="setBlockType('1)')"><b>1)</b> Angka Kurung (1)</div>
        <hr style="margin: 2px 0; border: 0; border-top: 1px solid #eee;">
        <div class="type-option" onclick="setBlockType('bullet')"><i class="fas fa-circle"></i> Bullet (•)</div>
        <div class="type-option" onclick="setBlockType('cube')"><i class="fas fa-square"></i> Cube (■)</div>
        <div class="type-option" onclick="setBlockType('dash')"><b>-</b> Dash (-)</div>
        <hr style="margin: 2px 0; border: 0; border-top: 1px solid #eee;">
        <div class="type-option" onclick="setBlockType('table')"><i class="fas fa-table"></i> Table</div>
        <div class="type-option" onclick="setBlockType('image')"><i class="fas fa-image"></i> Image</div>
    </div>

    <div id="pasteModal" class="modal-overlay">
        <div class="modal-box">
            <h3><i class="fas fa-magic"></i> Smart Paste</h3>
            <p style="font-size: 12px; color: #666;">Paste teks dari Word/PDF. Sistem akan mendeteksi poin secara otomatis.</p>
            <textarea id="rawPasteArea" style="width: 100%; height: 300px; padding: 10px; font-family: monospace; border: 1px solid #ccc;"></textarea>
            <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-outline" onclick="closePasteModal()">Batal</button>
                <button class="btn btn-primary" onclick="processSmartPaste()">Proses Teks</button>
            </div>
        </div>
    </div>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box" style="width: 300px;">
            <h4>Label Custom</h4>
            <input type="text" id="customInput" placeholder="Contoh: Pert 1" style="width:100%; padding:8px;">
            <div style="margin-top:15px; text-align:right;">
                <button class="btn btn-primary" onclick="applyCustomLabel()">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let docData = {
            title: "JUDUL MATERI PEMBELAJARAN",
            desc: "Deskripsi atau Pendahuluan Dokumen",
            children: [
                { type: "custom", manualLabel: "BAB I", title: "PENDAHULUAN", children: [] },
                { type: "paragraph", title: "Ekonomi publik adalah disiplin ilmu yang membahas tentang kebijakan pemerintah.", children: [] },
                { type: "A.", title: "Fungsi Alokasi", children: [
                    { type: "1.", title: "Penyediaan Barang Publik", children: [] },
                    { type: "paragraph", title: "Ini adalah paragraf penjelasan yang sejajar dengan huruf 'P' di atas.", children: [] }
                ]}
            ]
        };

        let activePath = null;

        // --- RENDERER ---
        function render() {
            const paper = document.getElementById('paper');
            paper.innerHTML = '';

            // Header Render
            const header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.marginBottom = '40px';
            header.innerHTML = `
                <div contenteditable="true" style="font-size:18pt; font-weight:bold;" onblur="docData.title=this.innerText">${docData.title}</div>
                <div contenteditable="true" style="font-size:12pt; font-style:italic; margin-top:5px;" onblur="docData.desc=this.innerText">${docData.desc}</div>
            `;
            paper.appendChild(header);

            renderNodes(docData.children, paper, []);
        }

        function renderNodes(nodes, container, path) {
            let counters = { 'A.': 0, 'a.': 0, '1.': 0, 'a)': 0, '1)': 0 };

            nodes.forEach((node, index) => {
                const currentPath = [...path, index];
                let markerTxt = "";

                // Hitung Marker Otomatis
                if (['A.', 'a.', '1.', 'a)', '1)'].includes(node.type)) {
                    counters[node.type]++;
                    markerTxt = getMarkerValue(node.type, counters[node.type]);
                } else if (node.type === 'bullet') markerTxt = "•";
                else if (node.type === 'cube') markerTxt = "■";
                else if (node.type === 'dash') markerTxt = "-";
                else if (node.type === 'custom') markerTxt = node.manualLabel || "?";

                // Baris Utama
                const row = document.createElement('div');
                row.className = 'block-row';

                // Kolom Kiri (Gutter Badge)
                const badgeContainer = document.createElement('div');
                badgeContainer.className = 'type-badge-container';
                badgeContainer.innerHTML = `<div class="type-badge" onclick="openSelector(event, [${currentPath}])">${getBadgeDisplay(node)}</div>`;
                row.appendChild(badgeContainer);

                // Kolom Kanan (Konten Kertas)
                const contentArea = document.createElement('div');
                contentArea.className = 'block-content';

                if (node.type === 'paragraph') {
                    contentArea.innerHTML = `<div class="content-editable content-paragraph" contenteditable="true" onblur="updateTitle([${currentPath}], this.innerText)">${node.title}</div>`;
                } 
                else if (node.type === 'image') {
                    contentArea.innerHTML = `
                        <div style="text-align:center; padding:10px; border:1px dashed #ccc; background:#f9f9f9;">
                            <img src="${node.url || 'https://via.placeholder.com/300?text=Klik+untuk+URL'}" style="max-width:100%; cursor:pointer;" onclick="editImage([${currentPath}])">
                            <div contenteditable="true" style="font-size:10pt; color:gray; margin-top:5px;" onblur="updateTitle([${currentPath}], this.innerText)">${node.title}</div>
                        </div>`;
                }
                else if (node.type === 'table') {
                    contentArea.innerHTML = `
                        <div style="overflow-x:auto;">${node.html || '<table border="1" style="width:100%; border-collapse:collapse;"><tr><td>Cell 1</td><td>Cell 2</td></tr></table>'}</div>
                        <button class="btn-mini" style="width:auto; padding:0 5px;" onclick="editTable([${currentPath}])">Edit Table HTML</button>
                    `;
                }
                else {
                    // Mode List Point
                    const flexRow = document.createElement('div');
                    flexRow.className = 'flex-row';
                    flexRow.innerHTML = `
                        <div class="inner-marker">${markerTxt}</div>
                        <div class="content-editable" contenteditable="true" onblur="updateTitle([${currentPath}], this.innerText)">${node.title}</div>
                    `;
                    // Key handler untuk Enter (Sibling Baru)
                    flexRow.querySelector('.content-editable').onkeydown = (e) => {
                        if(e.key === 'Enter') { e.preventDefault(); addSibling(currentPath); }
                    };
                    contentArea.appendChild(flexRow);
                }

                // Hover Controls
                const controls = document.createElement('div');
                controls.className = 'hover-controls';
                controls.innerHTML = `
                    <button class="btn-mini" onclick="addSibling([${currentPath}])" title="Tambah Baris">+</button>
                    <button class="btn-mini" onclick="addChild([${currentPath}])" title="Tambah Anak">></button>
                    <button class="btn-mini" style="color:red" onclick="removeNode([${currentPath}])">x</button>
                `;
                row.appendChild(controls);

                // Render Children (Recursive)
                if (node.children && node.children.length > 0) {
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'node-children';
                    renderNodes(node.children, childrenDiv, currentPath);
                    contentArea.appendChild(childrenDiv);
                }

                row.appendChild(contentArea);
                container.appendChild(row);
            });
        }

        // --- LOGIC HELPERS ---
        function getMarkerValue(type, n) {
            if (type === 'A.') return String.fromCharCode(64 + n) + ".";
            if (type === 'a.') return String.fromCharCode(96 + n) + ".";
            if (type === 'a)') return String.fromCharCode(96 + n) + ")";
            if (type === '1.') return n + ".";
            if (type === '1)') return n + ")";
            return "";
        }

        function getBadgeDisplay(node) {
            if (node.type === 'custom') return node.manualLabel || 'Custom';
            if (node.type === 'paragraph') return 'Paragraf';
            return node.type;
        }

        function updateMargin(val) {
            document.documentElement.style.setProperty('--indent-size', val + 'px');
            document.getElementById('marginVal').innerText = val + 'px';
        }

        // --- TREE OPERATIONS ---
        function findNode(path) {
            let curr = docData;
            path.forEach(idx => curr = curr.children[idx]);
            return curr;
        }

        function findParent(path) {
            let curr = docData;
            for(let i=0; i<path.length-1; i++) curr = curr.children[path[i]];
            return curr;
        }

        function updateTitle(path, text) { findNode(path).title = text; }

        function addSibling(path) {
            const parent = findParent(path);
            const idx = path[path.length - 1];
            const currentType = parent.children[idx].type;
            parent.children.splice(idx + 1, 0, { type: currentType, title: "", children: [] });
            render();
        }

        function addChild(path) {
            const node = findNode(path);
            let nextType = "dash";
            if(node.type === 'A.') nextType = '1.';
            else if(node.type === '1.') nextType = 'a.';
            node.children.push({ type: nextType, title: "", children: [] });
            render();
        }

        function removeNode(path) {
            if(!confirm("Hapus baris ini?")) return;
            findParent(path).children.splice(path[path.length - 1], 1);
            render();
        }

        // --- POPUP ACTIONS ---
        function openSelector(e, path) {
            e.stopPropagation();
            activePath = path;
            const sel = document.getElementById('typeSelector');
            sel.style.display = 'block';
            sel.style.top = e.clientY + 'px';
            sel.style.left = (e.clientX - 120) + 'px';
        }

        function setBlockType(type) {
            const node = findNode(activePath);
            node.type = type;
            document.getElementById('typeSelector').style.display = 'none';
            if (type === 'custom') {
                document.getElementById('customModal').style.display = 'flex';
            } else {
                render();
            }
        }

        function applyCustomLabel() {
            const node = findNode(activePath);
            node.manualLabel = document.getElementById('customInput').value;
            document.getElementById('customModal').style.display = 'none';
            render();
        }

        function editImage(path) {
            const url = prompt("Masukkan URL Gambar:", findNode(path).url || "");
            if(url) { findNode(path).url = url; render(); }
        }

        function editTable(path) {
            const html = prompt("Masukkan HTML Table:", findNode(path).html || "");
            if(html) { findNode(path).html = html; render(); }
        }

        // --- SMART PASTE ---
        function openPasteModal() { document.getElementById('pasteModal').style.display = 'flex'; }
        function closePasteModal() { document.getElementById('pasteModal').style.display = 'none'; }
        
        function processSmartPaste() {
            const raw = document.getElementById('rawPasteArea').value;
            const lines = raw.split('\n');
            let newNodes = [];

            lines.forEach(line => {
                let text = line.trim();
                if (!text) return;

                let type = "paragraph";
                // Regex deteksi poin pintar
                if (/^[A-Z]\./.test(text)) type = "A.";
                else if (/^\d+\./.test(text)) type = "1.";
                else if (/^[a-z]\./.test(text)) type = "a.";
                else if (/^\-/.test(text)) type = "dash";

                let cleanText = text.replace(/^[A-Z]\.\s?|^\d+\.\s?|^[a-z]\.\s?|^\-\s?/, "");
                newNodes.push({ type: type, title: cleanText, children: [] });
            });

            docData.children = [...docData.children, ...newNodes];
            render();
            closePasteModal();
        }

        // --- FILE MGMT ---
        function saveJson() {
            const blob = new Blob([JSON.stringify(docData, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = document.getElementById('docFilename').value + ".json";
            a.click();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            const reader = new FileReader();
            if (file.name.endsWith('.docx')) {
                reader.onload = (e) => mammoth.extractRawText({arrayBuffer: e.target.result}).then(r => {
                    document.getElementById('rawPasteArea').value = r.value;
                    openPasteModal();
                });
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = (e) => { docData = JSON.parse(e.target.result); render(); };
                reader.readAsText(file);
            }
        }

        function createNew() { if(confirm("Data akan dihapus?")) { docData.children = []; render(); } }

        // Close Popups on click outside
        window.onclick = (e) => {
            if(!e.target.closest('.type-badge')) document.getElementById('typeSelector').style.display = 'none';
        }

        // Init
        render();
    </script>
</body>
</html>