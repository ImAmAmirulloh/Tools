
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materi App - Ultimate Block Editor</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            /* === Light Theme Colors === */
            --bg-main: #e0e5ec;
            --bg-content: #ffffff;
            --bg-sidebar: #2c3e50;
            --bg-sidebar-header: #1a252f;
            --bg-sidebar-footer: #233342;
            --bg-hover: #f0f0f0;
            --bg-hover-danger: #fee2e2;
            --text-primary: #222222;
            --text-secondary: #666666;
            --text-on-dark: #ecf0f1;
            --text-danger: #dc2626;
            --border-primary: #cccccc;
            --border-secondary: #eeeeee;
            --border-strong: #333333;
            --border-sidebar: #34495e;
            --shadow-color-light: rgba(0,0,0,0.1);
            --shadow-color-medium: rgba(0,0,0,0.2);
            --shadow-color-heavy: rgba(0,0,0,0.4);
            --modal-overlay: rgba(0,0,0,0.6);
            --btn-primary-bg: #3498db;
            --btn-primary-text: white;

            /* === Layout Variables === */
            --paper-width: 210mm;
            --gutter-width: 150px;
            --sidebar-width: 260px;
            --indent-size: 40px; 
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* === Dark Theme Colors === */
                --bg-main: #1a202c;
                --bg-content: #2d3748;
                --bg-sidebar: #1e293b;
                --bg-sidebar-header: #0f172a;
                --bg-sidebar-footer: #152033;
                --bg-hover: #4a5568;
                --bg-hover-danger: #450a0a;
                --text-primary: #e2e8f0;
                --text-secondary: #a0aec0;
                --text-on-dark: #e2e8f0;
                --text-danger: #f87171;
                --border-primary: #4a5568;
                --border-secondary: #3e4c5f;
                --border-strong: #cbd5e0;
                --border-sidebar: #2d3748;
                --shadow-color-light: rgba(0,0,0,0.4);
                --shadow-color-medium: rgba(0,0,0,0.5);
                --shadow-color-heavy: rgba(0,0,0,0.6);
                --modal-overlay: rgba(0,0,0,0.8);
                --btn-primary-bg: #2b6cb0;
                --btn-primary-text: #ffffff;
            }
        }

        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; background-color: var(--bg-main); color: var(--text-primary); }
        * { box-sizing: border-box; }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width); background-color: var(--bg-sidebar); color: var(--text-on-dark);
            display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 2px 0 5px var(--shadow-color-light); z-index: 20;
        }
        #sidebar .brand { font-size: 1.2rem; text-align: center; padding: 20px 0; font-weight: bold; background: var(--bg-sidebar-header); }
        .sidebar-content { padding: 20px; flex-grow: 1; }
        .sidebar-footer { padding: 20px; background: var(--bg-sidebar-footer); border-top: 1px solid var(--border-sidebar); }

        /* --- MAIN AREA --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }

        .toolbar {
            background: var(--bg-content); padding: 10px 20px; height: 65px; border-bottom: 1px solid var(--border-primary);
            display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 4px var(--shadow-color-light); z-index: 10;
        }
        .toolbar input[type="text"], .toolbar input[type="range"] {
             background-color: var(--bg-main);
             color: var(--text-primary);
             border: 1px solid var(--border-primary);
        }

        .paper-container { flex-grow: 1; overflow-y: auto; padding: 40px; display: flex; justify-content: center; }

        /* EDITOR LAYOUT */
        .editor-wrapper {
            display: flex; flex-direction: row;
            width: calc(var(--paper-width) + var(--gutter-width) + 20px);
        }

        .paper {
            width: var(--paper-width); min-height: 297mm; background: var(--bg-content);
            padding: 25mm 25mm; box-shadow: 0 10px 25px var(--shadow-color-light);
            color: var(--text-primary); font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.5;
        }

        /* --- BLOCK SYSTEM --- */
        .block-row { display: flex; width: 100%; margin-bottom: 12px; position: relative; }

        .type-badge {
            display: inline-block; background: var(--bg-content); border: 2px solid var(--border-strong); border-radius: 4px;
            padding: 4px 10px; font-family: sans-serif; font-size: 11px; font-weight: bold;
            color: var(--text-primary); cursor: pointer; box-shadow: 3px 3px 0px var(--shadow-color-light);
            transition: 0.1s; user-select: none; white-space: nowrap;
        }
        .type-badge:hover { background: var(--bg-hover); transform: translate(-1px, -1px); }
        .type-badge:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0px var(--shadow-color-light); }

        /* KONTEN (KANAN) */
        .block-content { flex-grow: 1; display: flex; flex-direction: column; }
        .flex-row { display: flex; align-items: flex-start; }
        .inner-marker { 
            min-width: var(--indent-size); font-weight: bold; flex-shrink: 0; display: inline-block;
        }
        .content-editable { outline: none; flex-grow: 1; word-wrap: break-word; min-height: 1.2em; }
        .content-paragraph { text-align: justify; text-indent: 2em; }
        .node-children { 
            margin-top: 5px; margin-left: var(--indent-size);
            border-left: 1px dashed var(--border-secondary); padding-left: 5px; 
        }
        .node-children .content-paragraph { text-indent: 0 !important; }

        /* MODALS & DROPDOWNS */
        .type-selector {
            position: fixed; background: var(--bg-content); border: 2px solid var(--border-strong); border-radius: 6px;
            box-shadow: 5px 5px 20px var(--shadow-color-medium); z-index: 1000; display: none;
            width: 220px;
        }
        .selector-section { padding: 5px 0; }
        .selector-header { padding: 5px 12px; font-size: 10px; color: var(--text-secondary); font-weight: bold; text-transform: uppercase; }
        .selector-hr { margin: 4px 5px; border: 0; border-top: 1px solid var(--border-secondary); }

        .type-option { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; border-radius: 4px; margin: 0 5px; }
        .type-option:hover { background: var(--bg-hover); }
        .type-option-danger:hover { background: var(--bg-hover-danger); color: var(--text-danger); }
        .type-option b.fa-fw { display: inline-block; width: 1.25em; text-align: center; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-box { background: var(--bg-content); padding: 25px; border-radius: 8px; width: 500px; box-shadow: 0 15px 40px var(--shadow-color-heavy); }
        .modal-box h3, .modal-box h4, .modal-box p { color: var(--text-primary); }
        .modal-box p { color: var(--text-secondary); }
        .modal-box textarea, .modal-box input {
            background-color: var(--bg-main);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        /* BUTTONS */
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-primary { background: var(--btn-primary-bg); color: var(--btn-primary-text); }
        .btn-outline { background: var(--bg-content); border: 1px solid var(--border-primary); color: var(--text-primary); }
        .btn-outline:hover { background-color: var(--bg-hover); }
        .btn-full { width: 100%; margin-bottom: 10px; }

        /* BADGE DI GUTTER (KIRI) - No color changes needed */
        .type-badge-container {
            position: absolute; left: calc(-1 * var(--gutter-width) - 15px);
            width: var(--gutter-width); text-align: right; top: 0;
        }

        @media print {
            @page {
                size: A4;
                margin: 2cm;
            }

            body, .main-content, .paper-container {
                overflow: visible !important;
                height: auto !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            #sidebar, .toolbar, .type-badge-container, .type-selector {
                display: none !important;
            }
            
            .paper { 
                box-shadow: none !important; 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important;
                min-height: 0 !important;
                border: none !important;
                color: #000 !important;
            }
            .node-children {
                border-left: none !important;
            }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "rxjs": "https://esm.sh/rxjs@^7.8.2?conditions=es2015",
    "rxjs/operators": "https://esm.sh/rxjs@^7.8.2/operators?conditions=es2015",
    "rxjs/ajax": "https://esm.sh/rxjs@^7.8.2/ajax?conditions=es2015",
    "rxjs/webSocket": "https://esm.sh/rxjs@^7.8.2/webSocket?conditions=es2015",
    "rxjs/testing": "https://esm.sh/rxjs@^7.8.2/testing?conditions=es2015",
    "rxjs/fetch": "https://esm.sh/rxjs@^7.8.2/fetch?conditions=es2015",
    "@angular/core": "https://esm.sh/@angular/core@^21.1.3?external=rxjs",
    "immer": "https://esm.sh/immer@^11.1.3?external=rxjs",
    "@angular/common": "https://esm.sh/@angular/common@^21.1.3?external=rxjs"
  }
}
</script>
</head>
<body>

    <nav id="sidebar">
        <div class="brand">MATERI BUILDER</div>
        <div class="sidebar-content">
            <button class="btn btn-outline btn-full" onclick="openPasteModal()"><i class="fas fa-paste"></i> Smart Paste Text</button>
            <hr style="border: 0; border-top: 1px solid #444; margin: 20px 0;">
            <div style="font-size: 11px; color: #888; margin-bottom: 10px; letter-spacing: 1px;">IMPORT / EXPORT</div>
            <input type="file" id="fileInput" style="display:none" onchange="handleFileImport(this)">
            <button class="btn btn-outline btn-full" onclick="document.getElementById('fileInput').click()"><i class="fas fa-file-import"></i> Import DOCX / JSON</button>
            <button class="btn btn-primary btn-full" onclick="saveJson()"><i class="fas fa-save"></i> Save JSON</button>
        </div>
        <div class="sidebar-footer">
            <button class="btn btn-outline btn-full" onclick="createNew()"><i class="fas fa-file"></i> Buat Baru</button>
        </div>
    </nav>

    <div class="main-content">
        <div class="toolbar">
            <input type="text" id="docFilename" value="Materi_Ekonomi_Publik" style="padding: 8px; border-radius: 4px; width: 250px;">
            
            <div style="display:flex; align-items:center; gap:10px; border-left:1px solid var(--border-secondary); padding-left:15px; margin-left:10px; font-size:12px;">
                <i class="fas fa-arrows-alt-h"></i> Indentasi: 
                <input type="range" min="20" max="100" value="40" oninput="updateMargin(this.value)" style="cursor:pointer; width: 120px;">
                <span id="marginVal">40px</span>
            </div>

            <div style="flex-grow:1"></div>
            <button class="btn btn-outline" onclick="addRootNode()"><i class="fas fa-plus"></i> Tambah Bab</button>
            <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-print"></i> PDF / Print</button>
        </div>

        <div class="paper-container">
            <div class="editor-wrapper">
                <div class="paper" id="paper">
                    </div>
            </div>
        </div>
    </div>

    <div id="typeSelector" class="type-selector">
        <div class="selector-section">
            <div class="selector-header">Aksi</div>
            <div class="type-option" onclick="handleSelectorAction('addSibling')"><i class="fas fa-plus fa-fw"></i> Tambah Baris Baru</div>
            <div class="type-option" onclick="handleSelectorAction('addChild')"><i class="fas fa-long-arrow-alt-right fa-fw"></i> Tambah Anak</div>
            <div class="type-option type-option-danger" onclick="handleSelectorAction('removeNode')"><i class="fas fa-trash fa-fw"></i> Hapus</div>
        </div>
        <hr class="selector-hr" style="margin: 0 5px;">
        <div class="selector-section">
            <div class="selector-header">Tipe Blok</div>
            <div class="type-option" onclick="setBlockType('paragraph')"><i class="fas fa-align-left fa-fw"></i> Paragraf</div>
            <div class="type-option" onclick="setBlockType('custom')"><i class="fas fa-pen fa-fw"></i> Custom Point</div>
            <hr class="selector-hr">
            <div class="type-option" onclick="setBlockType('A.')"><b class="fa-fw">A.</b> Huruf Besar</div>
            <div class="type-option" onclick="setBlockType('a.')"><b class="fa-fw">a.</b> Huruf Kecil</div>
            <div class="type-option" onclick="setBlockType('1.')"><b class="fa-fw">1.</b> Angka</div>
            <hr class="selector-hr">
            <div class="type-option" onclick="setBlockType('bullet')"><i class="fas fa-circle fa-fw" style="font-size: 0.5rem;"></i> Bullet (•)</div>
            <div class="type-option" onclick="setBlockType('dash')"><b class="fa-fw">-</b> Dash (-)</div>
            <hr class="selector-hr">
            <div class="type-option" onclick="setBlockType('image')"><i class="fas fa-image fa-fw"></i> Image</div>
            <div class="type-option" onclick="setBlockType('table')"><i class="fas fa-table fa-fw"></i> Table</div>
        </div>
    </div>

    <div id="pasteModal" class="modal-overlay">
        <div class="modal-box">
            <h3><i class="fas fa-magic"></i> Smart Paste</h3>
            <p>Paste teks dari Word/PDF. Sistem akan mendeteksi poin secara otomatis.</p>
            <textarea id="rawPasteArea" style="width: 100%; height: 300px; padding: 10px; font-family: monospace; border-radius: 4px;"></textarea>
            <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-outline" onclick="closePasteModal()">Batal</button>
                <button class="btn btn-primary" onclick="processSmartPaste()">Proses Teks</button>
            </div>
        </div>
    </div>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box" style="width: 300px;">
            <h4>Label Custom</h4>
            <input type="text" id="customInput" placeholder="Contoh: Pert 1" style="width:100%; padding:8px; border-radius: 4px;">
            <div style="margin-top:15px; text-align:right;">
                <button class="btn btn-primary" onclick="applyCustomLabel()">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let docData = {
            title: "JUDUL MATERI PEMBELAJARAN",
            desc: "Deskripsi atau Pendahuluan Dokumen",
            children: [
                { type: "custom", manualLabel: "BAB I", title: "PENDAHULUAN", children: [] },
                { type: "paragraph", title: "Ekonomi publik adalah disiplin ilmu yang membahas tentang kebijakan pemerintah.", children: [] },
                { type: "A.", title: "Fungsi Alokasi", children: [
                    { type: "1.", title: "Penyediaan Barang Publik", children: [] },
                    { type: "paragraph", title: "Ini adalah paragraf penjelasan yang sejajar dengan huruf 'P' di atas.", children: [] }
                ]}
            ]
        };

        let activePath = null;

        // --- RENDERER ---
        function render() {
            const paper = document.getElementById('paper');
            paper.innerHTML = '';

            // Header Render
            const header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.marginBottom = '40px';
            header.innerHTML = `
                <div contenteditable="true" style="font-size:18pt; font-weight:bold;" onblur="docData.title=this.innerText">${docData.title}</div>
                <div contenteditable="true" style="font-size:12pt; font-style:italic; margin-top:5px;" onblur="docData.desc=this.innerText">${docData.desc}</div>
            `;
            paper.appendChild(header);

            renderNodes(docData.children, paper, []);
        }

        function renderNodes(nodes, container, path) {
            let counters = { 'A.': 0, 'a.': 0, '1.': 0, 'a)': 0, '1)': 0 };

            nodes.forEach((node, index) => {
                const currentPath = [...path, index];
                let markerTxt = "";

                // Hitung Marker Otomatis
                if (['A.', 'a.', '1.', 'a)', '1)'].includes(node.type)) {
                    counters[node.type]++;
                    markerTxt = getMarkerValue(node.type, counters[node.type]);
                } else if (node.type === 'bullet') markerTxt = "•";
                else if (node.type === 'cube') markerTxt = "■";
                else if (node.type === 'dash') markerTxt = "-";
                else if (node.type === 'custom') markerTxt = node.manualLabel || "?";

                // Baris Utama
                const row = document.createElement('div');
                row.className = 'block-row';

                // Kolom Kiri (Gutter Badge)
                const badgeContainer = document.createElement('div');
                badgeContainer.className = 'type-badge-container';
                badgeContainer.innerHTML = `<div class="type-badge" onclick="openSelector(event, [${currentPath}])">${getBadgeDisplay(node)}</div>`;
                row.appendChild(badgeContainer);

                // Kolom Kanan (Konten Kertas)
                const contentArea = document.createElement('div');
                contentArea.className = 'block-content';

                if (node.type === 'paragraph') {
                    contentArea.innerHTML = `<div class="content-editable content-paragraph" contenteditable="true" onblur="updateTitle([${currentPath}], this.innerText)">${node.title}</div>`;
                } 
                else if (node.type === 'image') {
                    contentArea.innerHTML = `
                        <div style="text-align:center; padding:10px; border:1px dashed var(--border-primary); background:var(--bg-main);">
                            <img src="${node.url || 'https://via.placeholder.com/300?text=Klik+untuk+URL'}" style="max-width:100%; cursor:pointer;" onclick="editImage([${currentPath}])">
                            <div contenteditable="true" style="font-size:10pt; color:var(--text-secondary); margin-top:5px;" onblur="updateTitle([${currentPath}], this.innerText)">${node.title}</div>
                        </div>`;
                }
                else if (node.type === 'table') {
                    contentArea.innerHTML = `
                        <div style="overflow-x:auto;">${node.html || '<table border="1" style="width:100%; border-collapse:collapse;"><tr><td>Cell 1</td><td>Cell 2</td></tr></table>'}</div>
                        <button class="btn-mini" style="width:auto; padding:0 5px;" onclick="editTable([${currentPath}])">Edit Table HTML</button>
                    `;
                }
                else {
                    // Mode List Point
                    const flexRow = document.createElement('div');
                    flexRow.className = 'flex-row';
                    flexRow.innerHTML = `
                        <div class="inner-marker">${markerTxt}</div>
                        <div class="content-editable" contenteditable="true" onblur="updateTitle([${currentPath}], this.innerText)">${node.title}</div>
                    `;
                    // Key handler untuk Enter (Sibling Baru)
                    flexRow.querySelector('.content-editable').onkeydown = (e) => {
                        if(e.key === 'Enter') { e.preventDefault(); addSibling(currentPath); }
                    };
                    contentArea.appendChild(flexRow);
                }

                // Render Children (Recursive)
                if (node.children && node.children.length > 0) {
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'node-children';
                    renderNodes(node.children, childrenDiv, currentPath);
                    contentArea.appendChild(childrenDiv);
                }

                row.appendChild(contentArea);
                container.appendChild(row);
            });
        }

        // --- LOGIC HELPERS ---
        function getMarkerValue(type, n) {
            if (type === 'A.') return String.fromCharCode(64 + n) + ".";
            if (type === 'a.') return String.fromCharCode(96 + n) + ".";
            if (type === 'a)') return String.fromCharCode(96 + n) + ")";
            if (type === '1.') return n + ".";
            if (type === '1)') return n + ")";
            return "";
        }

        function getBadgeDisplay(node) {
            if (node.type === 'custom') return node.manualLabel || 'Custom';
            if (node.type === 'paragraph') return 'Paragraf';
            return node.type;
        }

        function updateMargin(val) {
            document.documentElement.style.setProperty('--indent-size', val + 'px');
            document.getElementById('marginVal').innerText = val + 'px';
        }

        // --- TREE OPERATIONS ---
        function findNode(path) {
            let curr = docData;
            path.forEach(idx => curr = curr.children[idx]);
            return curr;
        }

        function findParent(path) {
            let curr = docData;
            for(let i=0; i<path.length-1; i++) curr = curr.children[path[i]];
            return curr;
        }

        function updateTitle(path, text) { findNode(path).title = text; }

        function addSibling(path) {
            const parent = findParent(path);
            const idx = path[path.length - 1];
            const currentType = parent.children[idx].type;
            parent.children.splice(idx + 1, 0, { type: currentType, title: "", children: [] });
            render();
        }
        
        function addRootNode() {
            docData.children.push({ type: 'custom', manualLabel: "BAB BARU", title: "JUDUL BAB", children: [] });
            render();
        }

        function addChild(path) {
            const node = findNode(path);
            let nextType = "dash";
            if(node.type === 'A.') nextType = '1.';
            else if(node.type === '1.') nextType = 'a.';
            node.children.push({ type: nextType, title: "", children: [] });
            render();
        }

        function removeNode(path) {
            if(!confirm("Hapus baris ini dan semua anaknya?")) return;
            findParent(path).children.splice(path[path.length - 1], 1);
            render();
        }

        // --- POPUP ACTIONS ---
        function openSelector(e, path) {
            e.stopPropagation();
            activePath = path;
            const sel = document.getElementById('typeSelector');
            sel.style.display = 'block';
            sel.style.top = e.clientY + 'px';
            sel.style.left = (e.clientX - 120) + 'px';
        }

        function handleSelectorAction(action) {
            if (!activePath) return;
            if (action === 'addSibling') addSibling(activePath);
            else if (action === 'addChild') addChild(activePath);
            else if (action === 'removeNode') removeNode(activePath);
            document.getElementById('typeSelector').style.display = 'none';
        }

        function setBlockType(type) {
            const node = findNode(activePath);
            node.type = type;
            document.getElementById('typeSelector').style.display = 'none';
            if (type === 'custom') {
                document.getElementById('customInput').value = node.manualLabel || '';
                document.getElementById('customModal').style.display = 'flex';
            } else {
                render();
            }
        }

        function applyCustomLabel() {
            const node = findNode(activePath);
            node.manualLabel = document.getElementById('customInput').value;
            document.getElementById('customModal').style.display = 'none';
            render();
        }

        function editImage(path) {
            const url = prompt("Masukkan URL Gambar:", findNode(path).url || "");
            if(url) { findNode(path).url = url; render(); }
        }

        function editTable(path) {
            const html = prompt("Masukkan HTML Table:", findNode(path).html || "");
            if(html) { findNode(path).html = html; render(); }
        }

        // --- SMART PASTE ---
        function openPasteModal() { document.getElementById('pasteModal').style.display = 'flex'; }
        function closePasteModal() { document.getElementById('pasteModal').style.display = 'none'; }
        
        function processSmartPaste() {
            const raw = document.getElementById('rawPasteArea').value;
            const lines = raw.split('\n');
            let newNodes = [];

            lines.forEach(line => {
                let text = line.trim();
                if (!text) return;

                let type = "paragraph";
                // Regex deteksi poin pintar
                if (/^[A-Z]\./.test(text)) type = "A.";
                else if (/^\d+\./.test(text)) type = "1.";
                else if (/^[a-z]\./.test(text)) type = "a.";
                else if (/^\-/.test(text)) type = "dash";

                let cleanText = text.replace(/^[A-Z]\.\s?|^\d+\.\s?|^[a-z]\.\s?|^\-\s?/, "");
                newNodes.push({ type: type, title: cleanText, children: [] });
            });

            docData.children = [...docData.children, ...newNodes];
            render();
            closePasteModal();
        }

        // --- FILE MGMT ---
        function saveJson() {
            const blob = new Blob([JSON.stringify(docData, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = document.getElementById('docFilename').value + ".json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            if (file.name.endsWith('.docx')) {
                reader.onload = (e) => mammoth.extractRawText({arrayBuffer: e.target.result}).then(r => {
                    document.getElementById('rawPasteArea').value = r.value;
                    openPasteModal();
                });
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = (e) => { 
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data && data.title && Array.isArray(data.children)) {
                            docData = data;
                            render();
                        } else {
                            alert('Format JSON tidak valid.');
                        }
                    } catch (err) {
                        alert('Gagal mem-parsing file JSON.');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            }
            input.value = ''; // Reset input
        }

        function createNew() { 
            if(confirm("Semua konten saat ini akan dihapus. Lanjutkan?")) { 
                docData.title = "JUDUL BARU";
                docData.desc = "Deskripsi baru";
                docData.children = []; 
                render(); 
            } 
        }

        // Close Popups on click outside
        window.onclick = (e) => {
            if(!e.target.closest('.type-badge') && !e.target.closest('.type-selector')) {
                document.getElementById('typeSelector').style.display = 'none';
            }
        }

        // Init
        render();
    </script>
</body>
</html>
